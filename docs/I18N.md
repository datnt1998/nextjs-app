# Internationalization (i18n)

Complete guide for using i18n features with next-intl v3.

## Quick Reference

### Imports

```typescript
// Server Components
import { getTranslations } from "next-intl/server";

// Client Components
import { useTranslations, useLocale } from "next-intl";

// Formatting
import { useFormatter } from "next-intl";
```

### Basic Usage

```typescript
// Server Component
const t = await getTranslations('namespace');
<p>{t('key')}</p>

// Client Component
const t = useTranslations('namespace');
<p>{t('key')}</p>

// With variables
<p>{t('welcome', { name: 'John' })}</p>

// Nested keys
<p>{t('section.subsection.key')}</p>
```

### File Structure

```
messages/
├── en/
│   ├── common.json      # Shared UI
│   ├── auth.json        # Authentication
│   ├── dashboard.json   # Dashboard
│   ├── items.json       # Items
│   ├── navigation.json  # Navigation
│   ├── errors.json      # Errors
│   └── metadata.json    # SEO
└── vi/
    └── ... (same)
```

## Overview

**Supported Locales:** English (en), Vietnamese (vi)

**Features:**

- Locale-based routing (`/en/dashboard`, `/vi/dashboard`)
- Server & Client Component support
- Type-safe translations
- SEO optimized (hreflang tags)
- Cookie-based locale persistence

## Adding Translations

### 1. Add to English

```json
// messages/en/namespace.json
{
  "myKey": "My translation"
}
```

### 2. Add to Vietnamese

```json
// messages/vi/namespace.json
{
  "myKey": "Bản dịch của tôi"
}
```

### 3. Use in Code

```typescript
const t = useTranslations('namespace');
<p>{t('myKey')}</p>
```

### 4. Validate

```bash
npm run validate:translations
```

## Creating Pages

### Basic Page

```typescript
// app/[locale]/my-page/page.tsx
import { getTranslations } from 'next-intl/server';

export default async function MyPage() {
  const t = await getTranslations('myPage');
  return <h1>{t('heading')}</h1>;
}
```

### Page with Metadata

```typescript
import { getTranslations } from 'next-intl/server';
import type { Metadata } from 'next';

export async function generateMetadata({ params: { locale } }): Promise<Metadata> {
  const t = await getTranslations({ locale, namespace: 'metadata' });
  return {
    title: t('myPage.title'),
    description: t('myPage.description'),
  };
}

export default async function MyPage() {
  const t = await getTranslations('myPage');
  return <h1>{t('heading')}</h1>;
}
```

### Dynamic Routes

```typescript
// app/[locale]/items/[id]/page.tsx
type Props = {
  params: { locale: string; id: string };
};

export default async function ItemPage({ params: { locale, id } }: Props) {
  const t = await getTranslations({ locale, namespace: 'items' });
  return (
    <div>
      <h1>{t('itemDetails')}</h1>
      <p>Item ID: {id}</p>
    </div>
  );
}
```

## Using Translations

### Server Components

```typescript
import { getTranslations } from 'next-intl/server';

export default async function ServerComponent() {
  const t = await getTranslations('common');
  return (
    <div>
      <button>{t('submit')}</button>
      <button>{t('cancel')}</button>
    </div>
  );
}
```

**Benefits:**

- Translations in initial HTML
- No client-side JavaScript needed
- Better performance and SEO

**When to use:**

- Static content
- Initial page render
- SEO-critical content

### Client Components

```typescript
'use client';
import { useTranslations } from 'next-intl';

export function ClientComponent() {
  const t = useTranslations('common');
  return (
    <button onClick={() => console.log('clicked')}>
      {t('submit')}
    </button>
  );
}
```

**Benefits:**

- Reactive updates
- Works with client-side interactivity
- Access to React hooks

**When to use:**

- Interactive components
- Components with state
- Event handlers

### Multiple Namespaces

```typescript
const tCommon = useTranslations('common');
const tErrors = useTranslations('errors');

<div>
  <button>{tCommon('submit')}</button>
  <p className="error">{tErrors('validationFailed')}</p>
</div>
```

### Current Locale

```typescript
import { useLocale } from 'next-intl';

export function LocaleDisplay() {
  const locale = useLocale();
  return <p>Current locale: {locale}</p>;
}
```

## Common Patterns

### Translation with Variables

```json
{
  "welcome": "Welcome back, {name}!",
  "itemCount": "You have {count} items"
}
```

```typescript
<h1>{t('welcome', { name: user.name })}</h1>
<p>{t('itemCount', { count: items.length })}</p>
```

### Pluralization

```json
{
  "items": {
    "zero": "No items",
    "one": "One item",
    "other": "{count} items"
  }
}
```

```typescript
<p>{t('items', { count: items.length })}</p>
```

### Rich Text

```json
{
  "terms": "I agree to the <link>terms and conditions</link>"
}
```

```typescript
<p>
  {t.rich('terms', {
    link: (chunks) => <a href="/terms">{chunks}</a>
  })}
</p>
```

### Date Formatting

```typescript
import { useFormatter } from 'next-intl';

export function DateDisplay({ date }: { date: Date }) {
  const format = useFormatter();
  return (
    <time>
      {format.dateTime(date, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })}
    </time>
  );
}
```

### Number Formatting

```typescript
import { useFormatter } from 'next-intl';

export function PriceDisplay({ amount }: { amount: number }) {
  const format = useFormatter();
  return (
    <span>
      {format.number(amount, {
        style: 'currency',
        currency: 'USD'
      })}
    </span>
  );
}
```

### Conditional Translation

```typescript
{
  isError ? t("errors.failed") : t("common.success");
}
```

### Form Validation

```typescript
import { useTranslations } from 'next-intl';
import { useForm } from 'react-hook-form';

export function LoginForm() {
  const t = useTranslations('auth');
  const { register, formState: { errors } } = useForm();

  return (
    <form>
      <input
        {...register('email', {
          required: t('validation.emailRequired'),
          pattern: {
            value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
            message: t('validation.emailInvalid')
          }
        })}
      />
      {errors.email && <span>{errors.email.message}</span>}
    </form>
  );
}
```

## SEO and Metadata

### Hreflang Implementation

**Utility:** `lib/i18n/metadata.ts`

**Functions:**

- `generateHreflangLinks(pathname)` - Generate alternate links
- `generateI18nMetadata(options)` - Complete metadata with i18n

**Usage:**

```typescript
import { generateI18nMetadata } from "@/lib/i18n/metadata";
import { getTranslations } from "next-intl/server";

export async function generateMetadata({ params }) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: "metadata.yourPage" });

  return generateI18nMetadata({
    locale,
    pathname: "/your-page",
    title: t("title"),
    description: t("description"),
  });
}
```

**Generated Metadata:**

```typescript
{
  title: "Page Title",
  description: "Page Description",
  openGraph: {
    title: "Page Title",
    description: "Page Description",
    locale: "en",
    alternateLocale: ["vi"],
    url: "https://example.com/en/page",
    siteName: "NextJS Starter Kit",
    type: "website"
  },
  alternates: {
    languages: {
      en: "https://example.com/en/page",
      vi: "https://example.com/vi/page"
    }
  }
}
```

**HTML Output:**

```html
<!-- Basic Meta -->
<title>Page Title</title>
<meta name="description" content="Page Description" />

<!-- Open Graph -->
<meta property="og:title" content="Page Title" />
<meta property="og:locale" content="en" />
<meta property="og:locale:alternate" content="vi" />

<!-- Hreflang -->
<link rel="alternate" hreflang="en" href="https://example.com/en/page" />
<link rel="alternate" hreflang="vi" href="https://example.com/vi/page" />
```

**SEO Benefits:**

- Search engine discovery of all language versions
- Correct language serving to users
- Improved social media sharing
- Duplicate content prevention
- International SEO optimization

## Locale Persistence

### Cookie Configuration

**File:** `lib/i18n/locale-cookie.ts`

**Settings:**

- Cookie Name: `NEXT_LOCALE`
- Max Age: 1 year
- Path: `/` (site-wide)
- SameSite: `Lax`

**Functions:**

```typescript
import {
  setLocaleCookie,
  getLocaleCookie,
  clearLocaleCookie,
} from "@/lib/i18n/locale-cookie";

// Set locale
setLocaleCookie("vi");

// Get locale
const locale = getLocaleCookie(); // Returns "en", "vi", or null

// Clear locale
clearLocaleCookie();
```

### User Flow

**First Visit:**

1. User visits site
2. Middleware detects locale from `Accept-Language`
3. User redirected to locale-prefixed URL
4. Middleware sets `NEXT_LOCALE` cookie

**Language Switch:**

1. User selects language
2. `setLocaleCookie()` saves preference
3. Browser navigates to new locale
4. Cookie expiration refreshed

**Subsequent Visits:**

1. User visits site
2. Middleware reads cookie
3. User redirected to preferred locale
4. Cookie expiration refreshed

## Navigation

### Link with Locale

```typescript
import { Link } from '@/i18n/routing';

export function Navigation() {
  return (
    <nav>
      <Link href="/dashboard">Dashboard</Link>
      <Link href="/items">Items</Link>
    </nav>
  );
}
```

### Programmatic Navigation

```typescript
'use client';
import { useRouter } from 'next/navigation';
import { useLocale } from 'next-intl';

export function NavigateButton() {
  const router = useRouter();
  const locale = useLocale();

  const handleClick = () => {
    router.push(`/${locale}/dashboard`);
  };

  return <button onClick={handleClick}>Go to Dashboard</button>;
}
```

## Adding New Locales

### 1. Update Configuration

```typescript
// i18n/config.ts
export const locales = ["en", "vi", "fr"] as const; // Add 'fr'
export type Locale = (typeof locales)[number];

export const localeNames: Record<Locale, string> = {
  en: "English",
  vi: "Tiếng Việt",
  fr: "Français", // Add French
};
```

### 2. Create Translation Directory

```bash
mkdir -p messages/fr
```

### 3. Copy and Translate Files

```bash
cp messages/en/*.json messages/fr/
# Then translate each file
```

### 4. Update Metadata Alternates

```typescript
export async function generateMetadata({ params: { locale } }) {
  return {
    alternates: {
      languages: {
        en: "/en",
        vi: "/vi",
        fr: "/fr", // Add new locale
      },
    },
  };
}
```

### 5. Test

1. Navigate to `/fr`
2. Verify translations display
3. Test language switcher
4. Verify metadata and hreflang

## Testing

### Unit Testing

```typescript
import { render, screen } from '@testing-library/react';
import { NextIntlClientProvider } from 'next-intl';
import MyComponent from '@/components/MyComponent';

const messages = {
  common: {
    submit: 'Submit',
    cancel: 'Cancel',
  },
};

describe('MyComponent', () => {
  it('should render translated text', () => {
    render(
      <NextIntlClientProvider locale="en" messages={messages}>
        <MyComponent />
      </NextIntlClientProvider>
    );

    expect(screen.getByText('Submit')).toBeInTheDocument();
  });
});
```

### Integration Testing

```typescript
import { test, expect } from "@playwright/test";

test.describe("i18n", () => {
  test("should switch languages", async ({ page }) => {
    await page.goto("/en/dashboard");
    await expect(page.locator("h1")).toContainText("Dashboard");

    await page.selectOption('select[name="locale"]', "vi");
    await page.waitForURL("/vi/dashboard");
    await expect(page.locator("h1")).toContainText("Bảng điều khiển");
  });

  test("should preserve query parameters", async ({ page }) => {
    await page.goto("/en/items?search=test&page=2");
    await page.selectOption('select[name="locale"]', "vi");
    await page.waitForURL("/vi/items?search=test&page=2");

    expect(page.url()).toContain("search=test");
    expect(page.url()).toContain("page=2");
  });
});
```

### Validation

```bash
npm run validate:translations
```

## Troubleshooting

| Issue                | Solution                                |
| -------------------- | --------------------------------------- |
| Key not found        | Check namespace and key in JSON         |
| Locale not switching | Verify locale in `i18n/config.ts`       |
| TypeScript errors    | Restart TS server                       |
| Not updating         | Restart dev server, clear `.next` cache |
| Hydration errors     | Don't mix server/client methods         |

## Best Practices

1. **Namespace Organization** - Keep related translations together
2. **Consistent Keys** - Use camelCase naming
3. **Avoid Hardcoded Text** - Always use translation keys
4. **Translation Variables** - Use variables for dynamic content
5. **Server Components First** - Prefer Server Components for performance
6. **Type Safety** - Leverage TypeScript validation
7. **Validation** - Run validation before deploying
8. **Documentation** - Document keys needing context
9. **Fallbacks** - Provide fallback translations
10. **Testing** - Test all locales

## Resources

- [next-intl Documentation](https://next-intl-docs.vercel.app/)
- [Next.js i18n](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
- [Project i18n Config](../i18n/config.ts)
- [Validation Script](../scripts/validate-translations.ts)
